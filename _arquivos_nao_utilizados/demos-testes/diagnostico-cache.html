<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico de Cache - MacDavis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #2c3e50, #e74c3c);
            color: white;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
        }
        .success { border-left-color: #27ae60; }
        .error { border-left-color: #e74c3c; }
        .warning { border-left-color: #f39c12; }
        .code-block {
            background: #000;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .header-info {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 5px;
            margin: 5px 0;
            font-size: 12px;
        }
        .timestamp {
            opacity: 0.7;
            font-size: 12px;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        button:hover { background: #2980b9; }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç DIAGN√ìSTICO PROFUNDO DE CACHE</h1>
        <p class="timestamp">Iniciado em: <span id="timestamp"></span></p>
        
        <div class="grid">
            <div>
                <button onclick="testarAPI()">üîß Testar API</button>
                <button onclick="testarHeaders()">üì° Verificar Headers</button>
                <button onclick="testarCache()">üíæ Testar Cache</button>
                <button onclick="testarArquivos()">üìÅ Verificar Arquivos</button>
            </div>
            <div>
                <button onclick="limparCacheTotal()">üßπ Limpar Cache Total</button>
                <button onclick="testarCatalogo()">üõçÔ∏è Testar Cat√°logo</button>
                <button onclick="recarregarForcado()">üîÑ Reload For√ßado</button>
                <button onclick="limparResultados()">‚ùå Limpar Tela</button>
            </div>
        </div>

        <div id="resultados"></div>
    </div>

    <script>
        document.getElementById('timestamp').textContent = new Date().toLocaleString('pt-BR');
        let testCount = 0;

        function log(titulo, conteudo, tipo = 'info') {
            const resultados = document.getElementById('resultados');
            testCount++;
            
            const cores = {
                success: 'success',
                error: 'error', 
                warning: 'warning',
                info: 'test-section'
            };
            
            const timestamp = new Date().toLocaleTimeString('pt-BR');
            
            resultados.innerHTML += `
                <div class="test-section ${cores[tipo]}">
                    <h3>[${testCount}] ${titulo}</h3>
                    <div class="timestamp">‚è∞ ${timestamp}</div>
                    <div>${conteudo}</div>
                </div>
            `;
            resultados.scrollTop = resultados.scrollHeight;
        }

        async function testarAPI() {
            log('üîß Testando API /api/motorcycles', 'Iniciando teste da API...', 'info');
            
            try {
                const startTime = performance.now();
                
                // Teste com diferentes m√©todos de cache-busting
                const tests = [
                    { name: 'Sem cache-bust', url: '/api/motorcycles' },
                    { name: 'Timestamp', url: `/api/motorcycles?t=${Date.now()}` },
                    { name: 'Random', url: `/api/motorcycles?r=${Math.random()}` },
                    { name: 'Vers√£o', url: `/api/motorcycles?v=${new Date().getTime()}` }
                ];
                
                let resultados = '<div class="code-block">';
                
                for (let test of tests) {
                    try {
                        const response = await fetch(test.url, {
                            method: 'GET',
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            }
                        });
                        
                        const data = await response.json();
                        const endTime = performance.now();
                        
                        resultados += `‚úÖ ${test.name}: ${data.length} motos (${Math.round(endTime - startTime)}ms)<br>`;
                        
                        if (data.length > 0) {
                            resultados += `   Primeira moto: ${data[0].marca || data[0].name} ${data[0].modelo || ''}<br>`;
                        }
                        
                    } catch (error) {
                        resultados += `‚ùå ${test.name}: ERRO - ${error.message}<br>`;
                    }
                }
                
                resultados += '</div>';
                log('‚úÖ Teste de API Conclu√≠do', resultados, 'success');
                
            } catch (error) {
                log('‚ùå Erro no Teste de API', `<div class="code-block">ERRO: ${error.message}</div>`, 'error');
            }
        }

        async function testarHeaders() {
            log('üì° Verificando Headers HTTP', 'Analisando headers de resposta...', 'info');
            
            try {
                const response = await fetch('/api/motorcycles', {
                    method: 'HEAD'
                });
                
                let headerInfo = '<div class="code-block">STATUS: ' + response.status + '<br><br>';
                
                // Headers importantes para cache
                const importantHeaders = [
                    'cache-control',
                    'pragma', 
                    'expires',
                    'etag',
                    'last-modified',
                    'content-type'
                ];
                
                importantHeaders.forEach(header => {
                    const value = response.headers.get(header);
                    headerInfo += `${header.toUpperCase()}: ${value || 'N√£o definido'}<br>`;
                });
                
                headerInfo += '</div>';
                
                // Analisar se h√° problemas
                const cacheControl = response.headers.get('cache-control');
                let analise = '';
                
                if (cacheControl && cacheControl.includes('no-cache')) {
                    analise = '<div class="header-info">‚úÖ Headers anti-cache est√£o CORRETOS</div>';
                } else {
                    analise = '<div class="header-info">‚ö†Ô∏è Headers anti-cache podem estar INCORRETOS</div>';
                }
                
                log('üì° Headers Analisados', headerInfo + analise, 'info');
                
            } catch (error) {
                log('‚ùå Erro ao Verificar Headers', `<div class="code-block">ERRO: ${error.message}</div>`, 'error');
            }
        }

        async function testarCache() {
            log('üíæ Testando Comportamento do Cache', 'Verificando cache do navegador...', 'info');
            
            let resultado = '<div class="code-block">';
            
            // Teste 1: localStorage
            try {
                localStorage.setItem('cache-test', 'teste-' + Date.now());
                const stored = localStorage.getItem('cache-test');
                resultado += '‚úÖ localStorage: FUNCIONANDO<br>';
                localStorage.removeItem('cache-test');
            } catch (error) {
                resultado += '‚ùå localStorage: ERRO - ' + error.message + '<br>';
            }
            
            // Teste 2: sessionStorage  
            try {
                sessionStorage.setItem('cache-test', 'teste-' + Date.now());
                const stored = sessionStorage.getItem('cache-test');
                resultado += '‚úÖ sessionStorage: FUNCIONANDO<br>';
                sessionStorage.removeItem('cache-test');
            } catch (error) {
                resultado += '‚ùå sessionStorage: ERRO - ' + error.message + '<br>';
            }
            
            // Teste 3: Service Worker
            if ('serviceWorker' in navigator) {
                const registrations = await navigator.serviceWorker.getRegistrations();
                resultado += `‚ö†Ô∏è Service Workers ativos: ${registrations.length}<br>`;
                if (registrations.length > 0) {
                    resultado += '   (Service Workers podem estar causando cache!)<br>';
                }
            } else {
                resultado += '‚úÖ Service Worker: N√ÉO SUPORTADO<br>';
            }
            
            resultado += '</div>';
            log('üíæ An√°lise de Cache', resultado, 'info');
        }

        async function testarArquivos() {
            log('üìÅ Verificando Arquivos Essenciais', 'Testando se os arquivos est√£o sendo servidos...', 'info');
            
            const arquivos = [
                '/catalog.html',
                '/catalog.js', 
                '/admin.html',
                '/admin.js',
                '/server.js',
                '/motorcycles.json'
            ];
            
            let resultado = '<div class="code-block">';
            
            for (let arquivo of arquivos) {
                try {
                    const response = await fetch(arquivo, { method: 'HEAD' });
                    resultado += `${response.ok ? '‚úÖ' : '‚ùå'} ${arquivo}: ${response.status}<br>`;
                } catch (error) {
                    resultado += `‚ùå ${arquivo}: ERRO - ${error.message}<br>`;
                }
            }
            
            resultado += '</div>';
            log('üìÅ Status dos Arquivos', resultado, 'info');
        }

        function limparCacheTotal() {
            log('üßπ Limpeza Total de Cache', 'Executando limpeza completa...', 'warning');
            
            let resultado = '<div class="code-block">';
            
            // Limpar localStorage
            const localCount = localStorage.length;
            localStorage.clear();
            resultado += `‚úÖ localStorage limpo (${localCount} itens removidos)<br>`;
            
            // Limpar sessionStorage  
            const sessionCount = sessionStorage.length;
            sessionStorage.clear();
            resultado += `‚úÖ sessionStorage limpo (${sessionCount} itens removidos)<br>`;
            
            // For√ßar reload sem cache
            resultado += 'üîÑ For√ßando reload sem cache...<br>';
            resultado += '</div>';
            
            log('üßπ Cache Limpo', resultado, 'success');
            
            setTimeout(() => {
                window.location.reload(true);
            }, 2000);
        }

        async function testarCatalogo() {
            log('üõçÔ∏è Testando Carregamento do Cat√°logo', 'Simulando carregamento do cat√°logo...', 'info');
            
            try {
                // Simular o que o catalog.js faz
                const response = await fetch('/api/motorcycles?nocache=' + Date.now());
                const motorcycles = await response.json();
                
                let resultado = '<div class="code-block">';
                resultado += `‚úÖ API respondeu com ${motorcycles.length} motocicletas<br><br>`;
                
                if (motorcycles.length > 0) {
                    resultado += 'PRIMEIRAS 3 MOTOCICLETAS:<br>';
                    motorcycles.slice(0, 3).forEach((moto, i) => {
                        const nome = moto.marca ? `${moto.marca} ${moto.modelo}` : moto.name;
                        resultado += `${i+1}. ${nome} - ${moto.ano || moto.year} (${moto.cor || moto.color})<br>`;
                    });
                } else {
                    resultado += '‚ö†Ô∏è NENHUMA MOTOCICLETA ENCONTRADA!<br>';
                }
                
                resultado += '</div>';
                log('‚úÖ Teste do Cat√°logo', resultado, 'success');
                
            } catch (error) {
                log('‚ùå Erro no Teste do Cat√°logo', `<div class="code-block">ERRO: ${error.message}</div>`, 'error');
            }
        }

        function recarregarForcado() {
            log('üîÑ Reload For√ßado', 'Recarregando p√°gina com Ctrl+F5 simulado...', 'warning');
            
            // Limpar cache e recarregar
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => {
                        caches.delete(name);
                    });
                    location.reload(true);
                });
            } else {
                location.reload(true);
            }
        }

        function limparResultados() {
            document.getElementById('resultados').innerHTML = '';
            testCount = 0;
            log('üîÑ Diagn√≥stico Reiniciado', 'Tela limpa. Pronto para novos testes.', 'info');
        }

        // Auto-executar alguns testes b√°sicos ao carregar
        window.onload = () => {
            setTimeout(() => {
                log('üöÄ Diagn√≥stico Iniciado', 'Sistema de diagn√≥stico carregado. Use os bot√µes para testar.', 'info');
            }, 500);
        };
    </script>
</body>
</html>