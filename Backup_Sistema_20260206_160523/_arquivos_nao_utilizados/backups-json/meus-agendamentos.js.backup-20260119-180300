// meus-agendamentos.js - Cliente gerencia seus pr√≥prios agendamentos
console.log('üì± Meus Agendamentos - Cliente iniciado');

const API_BASE = 'http://localhost:3000';

// M√°scara de telefone
document.getElementById('phoneInput')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    
    if (value.length <= 11) {
        value = value.replace(/^(\d{2})(\d)/g, '($1) $2');
        value = value.replace(/(\d)(\d{4})$/, '$1-$2');
    }
    
    e.target.value = value;
});

// Permitir buscar com Enter
document.getElementById('phoneInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchAppointments();
    }
});

// Buscar agendamentos por telefone
async function searchAppointments() {
    const phoneInput = document.getElementById('phoneInput');
    const phone = phoneInput.value.trim();
    
    if (!phone) {
        Toast.show('‚ö†Ô∏è Digite seu telefone', 'warning');
        phoneInput.focus();
        return;
    }
    
    const listContainer = document.getElementById('appointmentsList');
    listContainer.innerHTML = '<div class="loading">Buscando agendamentos</div>';
    
    try {
        const response = await fetch(`${API_BASE}/api/appointments`);
        
        if (!response.ok) {
            throw new Error('Erro ao buscar agendamentos');
        }
        
        const allAppointments = await response.json();
        
        // Normalizar telefone para compara√ß√£o (remove caracteres especiais)
        const normalizedPhone = phone.replace(/\D/g, '');
        
        // Filtrar agendamentos do cliente (suporta campos PT e EN)
        const myAppointments = allAppointments.filter(apt => {
            const aptPhone = (apt.phone || apt.telefone || '').replace(/\D/g, '');
            return aptPhone === normalizedPhone;
        });
        
        if (myAppointments.length === 0) {
            showEmptyState();
            return;
        }
        
        // Ordenar por data (mais recentes primeiro) - suporta PT e EN
        myAppointments.sort((a, b) => {
            const dateA = new Date((a.date || a.data) + ' ' + (a.time || a.horario));
            const dateB = new Date((b.date || b.data) + ' ' + (b.time || b.horario));
            return dateB - dateA;
        });
        
        displayAppointments(myAppointments);
        Toast.show(`‚úÖ ${myAppointments.length} agendamento(s) encontrado(s)`, 'success');
        
    } catch (error) {
        console.error('Erro ao buscar:', error);
        listContainer.innerHTML = '';
        Toast.show('‚ùå Erro ao buscar agendamentos', 'error');
    }
}

function displayAppointments(appointments) {
    const listContainer = document.getElementById('appointmentsList');
    
    listContainer.innerHTML = appointments.map(apt => {
        // Suportar campos PT e EN
        const date = apt.date || apt.data;
        const time = apt.time || apt.horario;
        const name = apt.name || apt.cliente;
        const phone = apt.phone || apt.telefone;
        const motorcycle = apt.motorcycle || apt.servicoId;
        const notes = apt.notes || apt.observacoes;
        const status = apt.status || 'pendente';
        
        const dateTime = new Date(date + ' ' + time);
        const now = new Date();
        const isPast = dateTime < now;
        const canManage = !isPast && status === 'pendente';
        const canConfirm = !isPast && status === 'pendente';
        
        // Formatar data
        const dateFormatted = new Date(date).toLocaleDateString('pt-BR', {
            day: '2-digit',
            month: 'long',
            year: 'numeric'
        });
        
        // Status em portugu√™s
        const statusMap = {
            'pendente': '‚è≥ Pendente',
            'agendado': '‚è≥ Pendente',
            'confirmado': '‚úÖ Confirmado',
            'realizado': '‚úîÔ∏è Realizado',
            'cancelado': '‚ùå Cancelado'
        };
        
        const statusText = statusMap[status] || status;
        
        return `
            <div class="appointment-card ${status}">
                <div class="status-badge ${status}">${statusText}</div>
                
                <div class="appointment-info">
                    <div class="info-row">
                        <span class="info-icon">üë§</span>
                        <span><strong>${name}</strong></span>
                    </div>
                    <div class="info-row">
                        <span class="info-icon">üìû</span>
                        <span>${phone}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-icon">üìÖ</span>
                        <span>${dateFormatted}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-icon">‚è∞</span>
                        <span>${time}</span>
                    </div>
                    
                    ${motorcycle ? `
                        <div class="motorcycle-info">
                            <div class="info-row">
                                <span class="info-icon">üèçÔ∏è</span>
                                <span><strong>Moto de Interesse</strong></span>
                            </div>
                            <div style="margin-top: 8px; padding-left: 34px; color: #555;">
                                ID: ${motorcycle}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${notes ? `
                        <div class="info-row">
                            <span class="info-icon">üìù</span>
                            <span>${notes}</span>
                        </div>
                    ` : ''}
                    
                    ${status === 'confirmado' && apt.confirmedAt ? `
                        <div class="info-row" style="color: #28a745; font-size: 0.9em; margin-top: 10px;">
                            <span class="info-icon">‚úì</span>
                            <span>Confirmado em ${new Date(apt.confirmedAt).toLocaleString('pt-BR')}</span>
                        </div>
                    ` : ''}
                    
                    ${status === 'cancelado' && apt.canceledAt ? `
                        <div class="info-row" style="color: #dc3545; font-size: 0.9em; margin-top: 10px;">
                            <span class="info-icon">‚úó</span>
                            <span>Cancelado em ${new Date(apt.canceledAt).toLocaleString('pt-BR')}</span>
                        </div>
                        ${apt.cancelReason ? `
                            <div class="info-row" style="padding-left: 34px; font-size: 0.9em; color: #666;">
                                Motivo: ${apt.cancelReason}
                            </div>
                        ` : ''}
                    ` : ''}
                </div>
                
                ${canManage ? `
                    <div class="appointment-actions">
                        ${canConfirm ? `
                            <button class="btn-action btn-confirm" onclick="confirmAppointment('${apt.id}')">
                                ‚úÖ Confirmar Presen√ßa
                            </button>
                        ` : ''}
                        <button class="btn-action btn-cancel" onclick="cancelAppointment('${apt.id}')">
                            ‚ùå Cancelar Agendamento
                        </button>
                    </div>
                ` : ''}
                
                ${isPast && status === 'pendente' ? `
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; color: #856404; font-size: 0.9em;">
                        ‚ö†Ô∏è Este agendamento j√° passou
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}
                        </div>
                    ` : ''}
                    
                    ${apt.status === 'cancelado' && apt.canceledAt ? `
                        <div class="info-row" style="color: #dc3545; font-size: 0.9em; margin-top: 10px;">
                            <span class="info-icon">‚úó</span>
                            <span>Cancelado em ${new Date(apt.canceledAt).toLocaleString('pt-BR')}</span>
                        </div>
                        ${apt.cancelReason ? `
                            <div class="info-row" style="padding-left: 34px; font-size: 0.9em; color: #666;">
                                Motivo: ${apt.cancelReason}
                            </div>
                        ` : ''}
                    ` : ''}
                </div>
                
                ${canManage ? `
                    <div class="appointment-actions">
                        ${canConfirm ? `
                            <button class="btn-action btn-confirm" onclick="confirmAppointment('${apt.id}')">
                                ‚úÖ Confirmar Presen√ßa
                            </button>
                        ` : ''}
                        <button class="btn-action btn-cancel" onclick="cancelAppointment('${apt.id}')">
                            ‚ùå Cancelar Agendamento
                        </button>
                    </div>
                ` : ''}
                
                ${isPast && apt.status === 'pendente' ? `
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 8px; color: #856404; font-size: 0.9em;">
                        ‚ö†Ô∏è Este agendamento j√° passou
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function showEmptyState() {
    const listContainer = document.getElementById('appointmentsList');
    listContainer.innerHTML = `
        <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h2>Nenhum agendamento encontrado</h2>
            <p>N√£o encontramos agendamentos com este telefone.</p>
            <p style="margin-top: 20px;">
                <a href="agendamento.html" style="color: white; text-decoration: underline;">
                    Agendar uma visita
                </a>
            </p>
        </div>
    `;
}

// Confirmar presen√ßa
async function confirmAppointment(appointmentId) {
    const confirmed = await Toast.confirm(
        '‚úÖ Confirmar Presen√ßa?',
        'Voc√™ confirma que comparecer√° neste hor√°rio?'
    );
    
    if (!confirmed) return;
    
    try {
        const response = await fetch(`${API_BASE}/api/appointments/${appointmentId}/confirm`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                confirmedBy: 'Cliente'
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Erro ao confirmar');
        }
        
        Toast.show('‚úÖ Presen√ßa confirmada com sucesso!', 'success');
        
        // Atualizar lista
        setTimeout(() => searchAppointments(), 1000);
        
    } catch (error) {
        console.error('Erro ao confirmar:', error);
        Toast.show('‚ùå ' + error.message, 'error');
    }
}

// Cancelar agendamento
async function cancelAppointment(appointmentId) {
    const confirmed = await Toast.confirm(
        '‚ùå Cancelar Agendamento?',
        'Tem certeza que deseja cancelar? Esta a√ß√£o n√£o pode ser desfeita.'
    );
    
    if (!confirmed) return;
    
    // Solicitar motivo
    const reason = prompt('Por favor, informe o motivo do cancelamento:');
    
    if (!reason || reason.trim() === '') {
        Toast.show('‚ö†Ô∏è √â necess√°rio informar o motivo', 'warning');
        return;
    }
    
    try {
        const response = await fetch(`${API_BASE}/api/appointments/${appointmentId}/cancel`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                cancelReason: reason.trim(),
                canceledBy: 'Cliente'
            })
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Erro ao cancelar');
        }
        
        Toast.show('‚úÖ Agendamento cancelado', 'success');
        
        // Atualizar lista
        setTimeout(() => searchAppointments(), 1000);
        
    } catch (error) {
        console.error('Erro ao cancelar:', error);
        Toast.show('‚ùå ' + error.message, 'error');
    }
}

// Auto-buscar se houver telefone salvo no localStorage
window.addEventListener('load', () => {
    const savedPhone = localStorage.getItem('lastSearchPhone');
    if (savedPhone) {
        document.getElementById('phoneInput').value = savedPhone;
        // N√£o buscar automaticamente, deixar o usu√°rio clicar
    }
});

// Salvar telefone buscado
const originalSearch = searchAppointments;
searchAppointments = async function() {
    const phone = document.getElementById('phoneInput').value.trim();
    if (phone) {
        localStorage.setItem('lastSearchPhone', phone);
    }
    await originalSearch();
};
